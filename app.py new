import os
import json
import io
import traceback
import pandas as pd
from PIL import Image
from flask import Flask, render_template, request, jsonify, send_from_directory, url_for, send_file
from werkzeug.utils import secure_filename
from dotenv import load_dotenv
import google.generativeai as genai
import glob
import re

import google.generativeai as genai
from dotenv import load_dotenv
import os

# Load API key tá»« file .env
load_dotenv()
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))

# Khá»Ÿi táº¡o model Gemini
model = genai.GenerativeModel('gemini-pro')


# --- Cáº¤U HÃŒNH ---
load_dotenv()
app = Flask(__name__)
app.secret_key = os.getenv("SECRET_KEY", "default_secret_key")
UPLOAD_FOLDER = 'uploads'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
ALLOWED_EXTENSIONS = {'png', 'jpg', 'jpeg', 'gif', 'webp', 'pdf'}
os.makedirs(UPLOAD_FOLDER, exist_ok=True)

# --- GEMINI ---
GEMINI_API_KEY = os.getenv("GEMINI_API_KEY")
if not GEMINI_API_KEY:
    print("[ERROR] ChÆ°a cáº¥u hÃ¬nh GEMINI_API_KEY trong .env")
genai.configure(api_key=GEMINI_API_KEY)

def allowed_file(filename):
    return '.' in filename and filename.rsplit('.', 1)[1].lower() in ALLOWED_EXTENSIONS

def extract_menu_from_image_gemini(image_path):
    try:
        model = genai.GenerativeModel('gemini-1.5-flash')

        img = Image.open(image_path)
        img_blob = io.BytesIO()
        img.save(img_blob, format='PNG')
        img_blob.seek(0)
        img_data = img_blob.read()

        prompt = """
Báº¡n lÃ  trá»£ lÃ½ AI nháº­n dáº¡ng thá»±c Ä‘Æ¡n. HÃ£y phÃ¢n tÃ­ch hÃ¬nh áº£nh thá»±c Ä‘Æ¡n vÃ  xuáº¥t danh sÃ¡ch mÃ³n Äƒn theo Ä‘á»‹nh dáº¡ng JSON chuáº©n vá»›i cÃ¡c trÆ°á»ng sau:
- PhÃ¢n loáº¡i: phÃ¢n loáº¡i (náº¿u cÃ³, vÃ­ dá»¥: MÃ³n chÃ­nh, MÃ³n phá»¥, NÆ°á»›c uá»‘ng...)
- TÃªn: tÃªn mÃ³n Äƒn
- GiÃ¡ tiá»n: giÃ¡ (chá»‰ láº¥y sá»‘, Ä‘Æ¡n vá»‹ lÃ  VND)
- MÃ´ táº£: mÃ´ táº£ tiáº¿ng Viá»‡t (náº¿u cÃ³)

HÃ£y Ä‘áº£m báº£o thÃ´ng tin rÃµ rÃ ng, khÃ´ng dá»‹ch, khÃ´ng thÃªm chi tiáº¿t má»›i.
Tráº£ káº¿t quáº£ dÆ°á»›i dáº¡ng JSON list chuáº©n (khÃ´ng cáº§n giáº£i thÃ­ch thÃªm).
"""



        response = model.generate_content(
            contents=[
                {"text": prompt},
                {"mime_type": "image/png", "data": img_data}
            ],
            stream=False
        )

        result_text = response.text.strip()
        print("ğŸ“¦ [Gemini Output Raw]:\n", result_text[:1000])

        # TrÃ­ch xuáº¥t JSON tá»« khá»‘i markdown
        json_match = re.search(r"```json(.*?)```", result_text, re.DOTALL)
        cleaned_output = json_match.group(1).strip() if json_match else result_text

        if not cleaned_output:
            print("[ERROR] Output tá»« Gemini API trá»‘ng.")
            return []

        menu_items = json.loads(cleaned_output)
        if isinstance(menu_items, list):
            return menu_items
        else:
            print("[ERROR] Káº¿t quáº£ khÃ´ng pháº£i JSON list.")
            return []
    except Exception as e:
        print(f"[ERROR] Gemini API failed: {e}")
        traceback.print_exc()
        return []


import google.generativeai as genai

def get_food_suggestions(num_people, min_budget, max_budget, menu_data):
    prompt = f"""
    TÃ´i cÃ³ má»™t danh sÃ¡ch thá»±c Ä‘Æ¡n {menu_data}. 
    HÃ£y gá»£i Ã½ cÃ¡c mÃ³n Äƒn phÃ¹ há»£p cho {num_people} ngÆ°á»i vá»›i ngÃ¢n sÃ¡ch tá»« {min_budget} Ä‘áº¿n {max_budget}.
    Tráº£ lá»i dÆ°á»›i dáº¡ng danh sÃ¡ch JSON.
    """
    response = genai.generate_text(prompt=prompt)
    return response  # Xá»­ lÃ½ káº¿t quáº£ trÆ°á»›c khi tráº£ vá»


def save_to_excel(data, excel_path):
    if not isinstance(data, list) or len(data) == 0:
        data = [{"error": "KhÃ´ng thá»ƒ phÃ¢n tÃ­ch thá»±c Ä‘Æ¡n, vui lÃ²ng thá»­ láº¡i!"}]
    try:
        df = pd.DataFrame(data)
        df.to_excel(excel_path, index=False)
        print(f"[INFO] ÄÃ£ lÆ°u file Excel: {excel_path}")
    except Exception as e:
        print("Lá»—i khi lÆ°u file Excel:", str(e))

def get_latest_excel_file():
    excel_files = glob.glob(os.path.join(app.config['UPLOAD_FOLDER'], '*.xlsx'))
    if not excel_files:
        return None
    return max(excel_files, key=os.path.getmtime)

import pandas as pd
import re

def parse_menu_table_from_text(text):
    # DÃ¹ng regex Ä‘á»ƒ trÃ­ch dÃ²ng dáº¡ng: TÃªn mÃ³n | GiÃ¡ | MÃ´ táº£
    lines = text.strip().split('\n')
    data = []
    for line in lines:
        if '|' in line:
            parts = [p.strip() for p in line.split('|')]
            if len(parts) >= 3:
                data.append({
                    'TÃªn mÃ³n': parts[0],
                    'GiÃ¡': parts[1],
                    'MÃ´ táº£': parts[2]
                })
    return pd.DataFrame(data)


# --- ROUTES ---
@app.route('/')
def index():
    return render_template('menu.html')
import json
import os

MENU_FILE_PATH = "processed_menu.json"

@app.route('/process_menu', methods=['POST'])
def process_menu():
    if 'menu_image' not in request.files:
        return jsonify({'error': 'No image uploaded'}), 400

    image = request.files['menu_image']
    image_path = "uploaded_image.png"
    image.save(image_path)

    # Gá»i Gemini API Ä‘á»ƒ trÃ­ch xuáº¥t thá»±c Ä‘Æ¡n
    menu_items = extract_menu_from_image_gemini(image_path)

    if not menu_items:
        return jsonify({'error': 'KhÃ´ng thá»ƒ nháº­n dáº¡ng thá»±c Ä‘Æ¡n'}), 400

    # LÆ°u thá»±c Ä‘Æ¡n vÃ o file JSON
    with open(MENU_FILE_PATH, "w", encoding="utf-8") as f:
        json.dump(menu_items, f, ensure_ascii=False, indent=2)

    return jsonify({'message': 'Thá»±c Ä‘Æ¡n Ä‘Ã£ Ä‘Æ°á»£c xá»­ lÃ½', 'menu': menu_items})


@app.route('/uploads/<filename>')
def download_file(filename):
    return send_from_directory(app.config['UPLOAD_FOLDER'], filename, as_attachment=True)


@app.route('/menu_suggestions', methods=['POST'])
def menu_suggestions():
    try:
        data = request.json
        print("ğŸ” Dá»¯ liá»‡u nháº­n Ä‘Æ°á»£c tá»« frontend:", data)

        num_people = data.get("num_people")
        min_budget = data.get("min_budget")
        max_budget = data.get("max_budget")

        if not num_people or not max_budget:
            return jsonify({"success": False, "message": "Thiáº¿u thÃ´ng tin sá»‘ ngÆ°á»i hoáº·c ngÃ¢n sÃ¡ch!"}), 400

        # Kiá»ƒm tra xem thá»±c Ä‘Æ¡n cÃ³ tá»“n táº¡i khÃ´ng
        menu_file_path = "menu_data.json"  # Thay báº±ng Ä‘Æ°á»ng dáº«n thá»±c táº¿
        if not os.path.exists(menu_file_path):
            return jsonify({"success": False, "message": "ChÆ°a cÃ³ thá»±c Ä‘Æ¡n!"}), 400

        with open(menu_file_path, "r", encoding="utf-8") as f:
            menu_data = json.load(f)
        
        print("ğŸ“œ Thá»±c Ä‘Æ¡n Ä‘Ã£ lÆ°u:", menu_data)

        if not menu_data:
            return jsonify({"success": False, "message": "Thá»±c Ä‘Æ¡n rá»—ng!"}), 400

        # Gá»i API Gemini Ä‘á»ƒ gá»£i Ã½ mÃ³n Äƒn
        suggestions = get_food_suggestions(num_people, min_budget, max_budget, menu_data)

        return jsonify({"success": True, "suggestions": suggestions})

    except Exception as e:
        print("âŒ Lá»—i xá»­ lÃ½ gá»£i Ã½ mÃ³n Äƒn:", str(e))
        return jsonify({"success": False, "message": "Lá»—i server"}), 500
    


@app.route('/get_saved_menu', methods=['GET'])
def get_saved_menu():
    if not os.path.exists(MENU_FILE_PATH):
        return jsonify([])  # Tráº£ vá» danh sÃ¡ch rá»—ng náº¿u chÆ°a cÃ³ dá»¯ liá»‡u

    with open(MENU_FILE_PATH, "r", encoding="utf-8") as f:
        menu_data = json.load(f)

    return jsonify(menu_data)



# --- CHáº Y á»¨NG Dá»¤NG ---
if __name__ == '__main__':
    app.run(host='0.0.0.0', port=5000, debug=True)
